# ResinHUP usage notes

How to use resinHUP to update devices that are not eligible for self-service update, or require manual update.

## Overview

At the time of writing, the eligible devices are the Raspberry Pi series, BeagleBone Black, and Intel NUC. Updates currently work only from 1.x to 1.x.

Make sure you have ssh access to the devices, and your setup is done [as it is shown in Scratch Pad](https://github.com/resin-io/hq/wiki/Scratch-Pad#getting-access).

The resinHUP update script to run over SSH is available [as part of `meta-resin`](https://github.com/resin-os/meta-resin/), **make sure you are using the [`1.X`](https://github.com/resin-os/meta-resin/tree/1.X) branch of `meta-resin`!** Check out that repository, and you'll find the script at `scripts/resinhup/run-resinhup-ssh.sh` Check the help with:

```
./run-resinhup-ssh.sh --help
```
for detailed help. The main flags are:

* `--ssh-host <host>`: which ssh proxy to go through to the device, usually that's `resin`, if ssh is set up as in Scratch Pad
* `--hostos-version <version>`: the version to upgrade to, eg. `1.24.1`
* `--supervisor-tag <version>`: the version of supervisor to upgrade to, eg. `v3.0.1`. Note the `v` in front of the version number, the tag is from the [`resin-supervisor` repo](https://github.com/resin-io/resin-supervisor), but should check the available supervisor version for the 1.x line at https://api.resin.io/v2/supervisor_release
* `--force`: ignore fingerprint checks. Use with extreme caution!
* `-u <uuid>`: the UUID of device to be updated, can add it multiple times
* `-m <number>`: maximum parallellism for updates, this many updates will run in parallell if possible
* `--only-supervisor`: this way can do supervisor update (without OS update) with the script too. (at the moment still have to add the `--hostos-version` value, even if an update is not performed, wip).

In practice you can create a script that has all the required parameters are there, and run the update by running that script. Eg.

```
SUPERVISOR_TAG="v3.0.1"
HOSTOS_VERSION="1.24.1"

./run-resinhup-ssh.sh \
  --ssh-host resin \
  --supervisor-tag ${SUPERVISOR_TAG} \
  --hostos-version ${HOSTOS_VERSION} \
  -m 5 \
  -u ..... \
  -u ..... \
  ....
```
where your `-u` parameters need to be carefully filled out.

When running the update, the script will create a separate `<uuid>.resinhup.log` file. Highly recommended following that logfile during the update process, for example by `tail -f *.log` (which will interleave the separate logfiles).

An output of the update script will look something like this:

```
[000000000][LOG][1/3] Updating <uuid1....> on resin.
[000000021][LOG][2/3] Updating <uuid2....> on resin.
[000000040][LOG][3/3] Updating <uuid3....> on resin.
[000000061][LOG]Waiting for all threads to finish...
[000001140][LOG]Updating <uuid2....> succeeded.
[000001310][LOG]Updating <uuid3....> succeeded.
[000001412][LOG]Updating <uuid1....> succeeded.

```

Each device's log should finish with something like this:

```
...
[000001556][LOG]Update suceeded in 320 seconds.
[000001556][LOG]Rebooting board in 5 seconds...
```
and should see it reboot if you are checking the device dashboard. The dasboard displays the stage of the update as well.

Congratulations, you've updated a device!

## Standard procedures and rules of thumb

* Make sure you are running from the up to date `meta-resin` code
* If running an update on a device + resinOS version that is not yet tested, or unsure whether it might work fine, run a test update on a local device if possible (set up a device yourself or ask someone to set one up for you), and try to catch any gotchas before updating a customer's device. If the required version of resinOS is not available, use the nearest version (most likely oldest version) and/or ask @agherzan whether there's any known issues with that resinOS version.
* Before the update log in one of the devices that is going to be updated to check that you have access, and check if the device is working fine, or if there are anything out of the ordinary (quickcheck).
* Bring up the devices' dashboard page to be able to quickly see the status during the update.
* If there are multiple devices to update, run the update on a single device first, from start to finish and check if there are any issues. If there are no issues, only after that do a parallallel update.
* Save the logs generated by resinHUP for at least some days after the update, so we can review if needed.

## Device and resinOS version specific notes

You need to check this section before you are updating a specific device for specific "known issues" and manual steps required to solve those:

### Raspberry Pi

For some versions (e.g. `1.1.4`) the fingerprints are known to fail because of issues with fingerprint generations. If in the test update the fingerprints fail but they fail on system files, only some, fails on some files that don't actually exist in the filesysmtem, and the files otherwise look good - might be this issue. Then proceed with the update using `--force`, but be vigilant.

When updating from an `rce` version (some before `1.8.0`), on the next boot with the new system, the docker containers need to be transformed to be addressed by their hash. That's a time-consuming procedure, and the `docker` service might time out during that, and thus will be continuously restarting after the update, and never finishing the conversion. If that's the case, stop the service, and run the docker start command manually; see the `docker.service`. Should be (but check!)

```
systemctl stop docker
/usr/bin/docker daemon --log-driver=journald -s btrfs --dns 172.17.0.1`
```
When finished and docker is up and running fine, reboot:

### BeagleBone Black

For resinOS versions below `1.26.0` should apply a fix for BBB memory pressure issues, which is taking [`fix-mmc-bbb.conf`](https://github.com/resin-os/resin-beaglebone/blob/1.X/layers/meta-resin-beaglebone/recipes-core/fix-mmc-bbb/files/fix-mmc-bbb.conf) and placing it into the relevant directory (should be `/etc/sysctl.d`), then restarting the device to apply the changes. After this, the update should succeed.
