# https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: Remove preview
description: Remove preview from GitHub Pages

inputs:
  json:
    description: "JSON stringified object containing all the inputs from the calling workflow"
    required: true
  secrets:
    description: "JSON stringified object containing all the secrets from the calling workflow"
    required: true

runs:
  using: "composite"
  steps:
    - name: Create an empty directory
      shell: bash
      run: |
        echo "emptydir=$(mktemp -d)" >> $GITHUB_ENV

    # https://github.com/crazy-max/ghaction-import-gpg
    # import gpg key for verified commits
    - name: Import GPG key
      id: gpg
      uses: crazy-max/ghaction-import-gpg@v4
      with:
        gpg_private_key: ${{ fromJSON(inputs.secrets).GPG_PRIVATE_KEY }}
        passphrase: ${{ fromJSON(inputs.secrets).GPG_PASSPHRASE }}
        git_config_global: true
        git_user_signingkey: true
        git_commit_gpgsign: true

    - name: Export env vars
      shell: bash
      env:
        target-branch: gh-pages
        # clean the existing folder called gh-preview/pr-#
        target-folder: gh-preview/pr-${{ github.event.number }}
        preview-url: https://handbook.balena.io/gh-preview/pr-${{ github.event.number }}/
      # deploy an empty directory to the preview path as a way to clean up
      run: |
        echo "source_folder=$(mktemp -d)" >> $GITHUB_ENV
        echo "target_branch=${target_branch}" >> $GITHUB_ENV
        echo "target_folder=${target_folder}" >> $GITHUB_ENV
        echo "published_url=${published_url}" >> $GITHUB_ENV

    # https://github.com/JamesIves/github-pages-deploy-action
    - name: Remove preview from GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: ${{ env.source_folder }}
        branch: ${{ env.target_branch }}
        target-folder: ${{ env.target_folder }}
        # use the provided flowzone token
        token: ${{ fromJSON(inputs.secrets).FLOWZONE_TOKEN }}
        # use embedded name and email from gpg key for commit
        git-config-name: ${{ steps.gpg.outputs.name }}
        git-config-email: ${{ steps.gpg.outputs.email }}
        force: false
        commit-message: |
          Removing ${{ env.target_folder }} from ${{ env.target_branch }}

    - name: Create deployment comment
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: gh-preview
        GITHUB_TOKEN: ${{ fromJSON(inputs.secrets).FLOWZONE_TOKEN }}
        message: |
          :rocket: Preview removed because the pull request was closed.
